# SceneBlueprint 测试框架与质量保证

> 状态：当前测试体系总览  
> doc_status: active  
> last_reviewed: 2026-02-15

## 1. 整体架构

### 测试框架定位

SceneBlueprint 测试框架专注于 **Unity Editor 内的便捷测试体验**，不涉及 CI/CD 或 Git Hook。

```
测试执行流程：

  菜单「运行测试」
       ↓
  SceneBlueprintTestRunner
       ↓
  Unity TestRunnerApi.Execute()  ←── Filter: assemblyNames 白名单
       ↓
  TestRunnerFilter (ICallbacks)  ←── 收集每个测试结果
       ↓
  RunFinished → GenerateTestReport()  ←── 自动生成报告 + 弹窗
```

### 测试分层

| 层级 | 目标 | 数量/占比 | 位置 |
|------|------|-----------|------|
| **单元测试** | 单个类/方法的正确性 | 大量 | `Tests/Unit/Core/` |
| **集成测试** | 多组件协作 | 中等 | `Tests/Integration/` |
| **E2E 测试** | 完整用户场景 | 少量 | `Tests/E2E/` |

---

## 2. 核心组件

### 2.1 TestRunnerFilter

- **职责**：注册 `ICallbacks` 回调，收集测试结果，自动生成报告
- **初始化**：`[InitializeOnLoadMethod]` 自动注册
- **数据流**：`TestFinished` → 收集 `TestResultData` → `RunFinished` → `GenerateTestReport()`

### 2.2 TestConfiguration (ScriptableObject)

- **职责**：持久化测试配置
- **关键字段**：`allowedAssemblies`、`enableAssemblyFiltering`、`verboseLogging`
- **加载优先级**：指定路径 → Resources → AssetDatabase 搜索 → 内存默认值

### 2.3 SceneBlueprintTestRunner

- **职责**：通过 `TestRunnerApi.Execute()` 发起白名单过滤后的测试执行
- **不负责**：结果收集和报告生成（由 TestRunnerFilter 回调处理）

### 2.4 TestMenuItems

- **职责**：3 个 Editor 菜单项（运行测试、测试配置、帮助指南）

---

## 3. 测试编写规范

### 3.1 命名约定

| 类型 | 格式 | 示例 |
|------|------|------|
| 测试类 | `{ClassName}Tests` | `PropertyBagTests` |
| 测试方法 | `Method_Scenario_Expected` | `Get_NonExistentKey_ReturnsDefault` |

### 3.2 AAA 模式

```csharp
[Test]
public void ActionRegistry_Register_CanRetrieveByTypeId()
{
    // Arrange
    var registry = new ActionRegistry();
    var def = new ActionDefinition { TypeId = "Test.Action" };

    // Act
    registry.Register(def);

    // Assert
    Assert.IsTrue(registry.TryGet("Test.Action", out var result));
    Assert.AreEqual("Test.Action", result.TypeId);
}
```

### 3.3 断言标准

```csharp
// ❌ 不清晰
Assert.IsTrue(result);

// ✅ 清晰 + 错误消息
Assert.IsTrue(registry.TryGet("Flow.Start", out _), "Flow.Start 应该被注册");
```

### 3.4 FIRST 原则

- **Fast**：快速执行
- **Independent**：测试间独立
- **Repeatable**：可重复执行
- **Self-Validating**：自验证结果
- **Timely**：及时编写

---

## 4. 设计约定

### PropertyBag 默认值语义

遵循 C# 默认语义：
- `bag.Get<string>("missing")` → `null`
- `bag.Get<int>("missing")` → `0`
- `bag.Get<float>("missing")` → `0f`
- `bag.Get<bool>("missing")` → `false`
- 需要非 null 默认值时显式提供：`bag.Get<string>("key", "")`

### 测试数据管理

- 使用 `TestDataBuilder` 创建测试数据，避免硬编码
- 每个测试独立创建对象，不共享可变状态
- 不依赖测试执行顺序

---

## 5. 质量标准

### 测试通过要求

- 所有单元测试必须通过
- 所有集成测试必须通过
- 无测试代码的 Warning 或 Error

### 性能标准

- 完整测试套件执行时间 < 30 秒
- 单个测试方法 < 1 秒

### 开发流程

1. **编写失败测试** → 描述预期行为 (TDD)
2. **实现最小功能** → 让测试通过
3. **重构优化** → 保持测试通过
4. **运行全量测试** → 确认无回归

### Bug 修复流程

1. **编写失败测试** → 重现 Bug
2. **修复 Bug** → 让测试通过
3. **回归测试** → 确保不影响其他功能

---

## 6. 工具类

### TestDataBuilder

快速创建标准化测试数据，避免重复代码。

### AssertionExtensions

表达性断言扩展，提供 `ShouldContainKey`、`ShouldHavePort` 等流畅 API。

### CoverageAnalyzer

基础代码覆盖率分析（基于类级别统计）。

---

详细使用方法参见 `Tests/SceneBlueprint测试框架使用指南.md`。
