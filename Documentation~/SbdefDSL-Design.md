# SceneBlueprint DSL 设计文档 — `.sbdef`

> 版本：v0.2  
> 状态：设计阶段，持续迭代

---

## 1. 背景与目标

### 1.1 现有痛点

当前新增一个 ActionNode 需要手动修改多处：

| 步骤 | 文件 | 内容 |
|---|---|---|
| 1 | `AT.cs` | 添加类型 ID 字符串常量 |
| 2 | `ActionPortIds.cs` | 添加端口 ID 嵌套类 |
| 3 | `IActionDefinitionProvider` 实现 | 注册 ActionDefinition |
| 4 | System `.cs` | 手写业务逻辑（合理，不应生成）|

步骤 1-3 是纯粹的"数据搬运"，没有业务逻辑，却容易出错（拼写不一致、忘记同步等）。

### 1.2 目标

引入 `.sbdef` 文件作为 Action/Marker **声明的单一数据源**：

- **写一次，生成多处**：保存 `.sbdef` 自动重新生成对应的 `.g.cs` 常量文件
- **类型安全**：System 引用生成的常量，拼写错误在编译期暴露
- **低侵入**：不改变 System 的手写方式，不强制修改现有架构
- **可增量迁移**：新 Action 用 DSL，旧 Action 可保持现状共存

---

## 2. DSL 语法设计

### 2.1 文件结构

```
// 可选：文件级注释（// 行注释）
// 文件可包含多个 action / marker 块，无顺序要求

namespace VFX              // 可选，默认使用文件名作为命名空间

action VFX.CameraShake {
    port float  Duration   = 0.5
    port float  Intensity  = 1.0
    port float  Frequency  = 20.0
}

action VFX.ScreenFlash {
    port float  Duration   = 0.3
    port color  Color      = white
}

marker Point {
    label    "点标记"
    gizmo    sphere(0.3)
}

marker Area {
    label    "区域标记"
    gizmo    wire_sphere
}
```

### 2.2 关键字与语法规则

```ebnf
file        ::= statement*
statement   ::= action_decl | marker_decl | line_comment

action_decl ::= 'action' type_id '{' port_decl* '}'
type_id     ::= IDENT ('.' IDENT)*          // e.g. VFX.CameraShake

port_decl   ::= 'port' type_name IDENT ('=' literal)?
type_name   ::= 'float' | 'int' | 'bool' | 'string' | 'color' | IDENT

marker_decl ::= 'marker' IDENT '{' marker_prop* '}'
marker_prop ::= label_prop | gizmo_prop
label_prop  ::= 'label' STRING
gizmo_prop  ::= 'gizmo' gizmo_shape
gizmo_shape ::= 'sphere' ('(' NUMBER ')')? | 'wire_sphere' | 'box' | 'wire_box'

literal     ::= NUMBER | STRING | 'true' | 'false' | COLOR_LITERAL
line_comment ::= '//' ~'\n'* '\n'
```

### 2.3 类型映射

| DSL 类型 | C# 类型 |
|---|---|
| `float` | `float` |
| `int` | `int` |
| `bool` | `bool` |
| `string` | `string` |
| `color` | `UnityEngine.Color` |
| 其他 IDENT | 透传为 C# 类型名（用户自定义）|

---

## 3. 生成产物

### 3.1 Action → 生成两个常量文件

**输入：**
```
// vfx.sbdef
action VFX.CameraShake {
    port float Duration  = 0.5
    port float Intensity = 1.0
}
```

**生成：`Generated/AT.Vfx.g.cs`**
```csharp
// <auto-generated> 由 SbdefCodegen 生成，请勿手动修改 </auto-generated>
namespace SceneBlueprint.Runtime
{
    public static partial class AT
    {
        public static partial class Vfx
        {
            public const string CameraShake = "VFX.CameraShake";
        }
    }
}
```

**生成：`Generated/ActionPortIds.Vfx.g.cs`**
```csharp
// <auto-generated> 由 SbdefCodegen 生成，请勿手动修改 </auto-generated>
namespace SceneBlueprint.Runtime
{
    public static partial class ActionPortIds
    {
        public static class VFXCameraShake
        {
            public const string Duration  = "Duration";
            public const string Intensity = "Intensity";
        }
    }
}
```

### 3.2 Marker → 生成骨架（partial class）

**输入：**
```
marker Point {
    label "点标记"
    gizmo sphere(0.3)
}
```

**生成：`Generated/Markers.g.cs`**
```csharp
// <auto-generated> 由 SbdefCodegen 生成，请勿手动修改 </auto-generated>
namespace SceneBlueprint.Runtime.Markers
{
    // 手写逻辑放在 PointMarker.cs（partial class），此文件只生成注册部分
    public partial class PointMarker : SceneMarker
    {
        public override string MarkerTypeId => "Point";
        public override string DisplayLabel => "点标记";
    }
}
```

> Gizmo 渲染逻辑保留在手写的 `partial` 另一半，生成文件不碰业务代码。

---

## 4. 生成管道实现

### 4.1 整体流程

参考 Framesync 的 `FSDSLAssetImporter`，使用 **`ScriptedImporter`** 注册 `.sbdef` 扩展名，而非普通 `AssetPostprocessor`。区别在于：
- `ScriptedImporter` 使 `.sbdef` 成为 Unity 可识别的资产，可在 Project 窗口双击预览
- 内部嵌套一个 `AssetPostprocessor` 监听 `.sbdef` 变动，触发代码生成

```
.sbdef 文件（保存/导入）
    ↓
SbdefAssetImporter : ScriptedImporter  （注册 "sbdef" 扩展名）
    ↓ 内部 AssetPostprocessor
SbdefLexer         → Token[]
    ↓
SbdefParser        → SbdefAst
    ↓
┌─────────────────────┬──────────────────────┐
ActionCodeEmitter     MarkerCodeEmitter
  → AT.*.g.cs           → Markers.g.cs
  → ActionPortIds.*.g.cs
    ↓
File.WriteAllText()  （仅在内容变化时写入，避免无效触发）
    ↓
AssetDatabase.Refresh()
```

### 4.2 AST 结构（C#）

```csharp
// 极简 AST，只覆盖 MVP 需要的节点
record SbdefFile(List<SbdefStatement> Statements);

abstract record SbdefStatement;
record ActionDecl(string TypeId, List<PortDecl> Ports) : SbdefStatement;
record MarkerDecl(string Name, string Label, GizmoShape Gizmo) : SbdefStatement;

record PortDecl(string TypeName, string Name, string? Default);

enum GizmoShape { Sphere, WireSphere, Box, WireBox }
```

### 4.3 文件放置约定

**决策：`.sbdef` 文件只放在用户项目，框架包不使用 DSL**

- 框架内置 Action（`Flow.Join`、`Flow.Filter`）已在 C# 里定义，**不迁移**到 `.sbdef`
- 游戏特定 Action / Marker 定义放在 `SceneBlueprintUser/Definitions/`
- 生成文件提交到 git（CI 无需额外 codegen 步骤）

```
SceneBlueprintUser/
  Definitions/
    vfx.sbdef              ← 用户手写
    spawn.sbdef            ← 用户手写
  Generated/               ← 自动生成，提交到 git
    AT.Vfx.g.cs
    AT.Spawn.g.cs
    ActionPortIds.Vfx.g.cs
    ActionPortIds.Spawn.g.cs
```

| 类型 | 源文件位置 | 生成文件位置 |
|---|---|---|
| Action 常量 | `SceneBlueprintUser/Definitions/*.sbdef` | `SceneBlueprintUser/Generated/AT.*.g.cs` |
| Action 端口 | 同上 | `SceneBlueprintUser/Generated/ActionPortIds.*.g.cs` |
| Marker 骨架 | 同上 | `SceneBlueprintUser/Generated/Markers.g.cs` |

---

## 5. 与现有系统的兼容策略

### 5.1 增量迁移

- 旧的手写 `AT.cs` / `ActionPortIds.cs` 中的常量**继续有效**，无需删除
- 新增 Action 使用 `.sbdef` 定义，生成的类用 `partial` 扩展同名类
- `AT` 和 `ActionPortIds` 均已声明为 `static partial class`，支持跨文件扩展

### 5.2 Action 注册（IActionDefinitionProvider）

`.sbdef` 暂不生成 `IActionDefinitionProvider` 实现，原因：
- Provider 中包含 Port 的元数据（显示名、描述、验证规则），超出纯常量范畴
- 可在 v0.2 阶段扩展 DSL，为 port 添加 `label`/`description` 属性后再生成

### 5.3 System 不生成

System 中包含业务逻辑（如何响应 Port 值），永远手写。DSL 只管"有什么端口"，不管"端口怎么用"。

---

## 6. 迭代路线

| 版本 | 范围 | 关键交付物 |
|---|---|---|
| **v0.1 MVP** | `action` 关键字，生成 `AT` + `ActionPortIds` 常量 | Lexer、Parser、ActionCodeEmitter、AssetPostprocessor |
| **v0.2** | port 添加 `label`/`description`，生成 `IActionDefinitionProvider` | ProviderCodeEmitter |
| **v0.3** | `marker` 关键字，生成 Marker 骨架 | MarkerCodeEmitter |
| **v0.4** | IDE 支持：.sbdef 语法高亮（TextMate grammar）、Windsurf/VSCode 扩展 | `sbdef.tmLanguage.json` |
| **v0.5** | 错误诊断：解析错误显示在 Unity Console，定位到 .sbdef 行号 | `SbdefDiagnostic` |

---

## 7. 已决策事项

1. **生成物提交 git** ✅  
   生成文件纳入版本控制，CI 直接编译无需额外 codegen 步骤。

2. **`.sbdef` 只在用户层，框架包不使用 DSL** ✅  
   框架内置 Action 保持 C# 手写不变。用户 Action / Marker 的 `.sbdef` 放在 `SceneBlueprintUser/Definitions/`。

3. **port 默认值：v0.1 仅作文档注释，v0.2 写入元数据** ✅  
   - v0.1：`= 0.5` 生成为代码注释 `// Default: 0.5`，不影响运行时
   - v0.2：扩展 DSL 支持 `label`/`description` 后，生成 `IActionDefinitionProvider`，默认值写入 `PortDefinition.DefaultValue`

4. **类型 ID 大小写转换规则** ✅  
   DSL 里的类型 ID 字符串**原样保留**为运行时常量值，类名使用 PascalCase 转换：
   ```
   DSL 写法:   VFX.CameraShake
   常量值:     "VFX.CameraShake"    ← 原样，运行时匹配用
   类名:       AT.Vfx.CameraShake   ← 全大写缩写 → 首字母大写其余小写
   
   转换规则:   VFX → Vfx / AI → Ai / CameraShake → CameraShake（不变）
   ```
   实现：Emitter 中用 `ToPascalSegment(string s)` 统一处理。

---

## 附录：参考对比

| | Framesync `.qtn` | SceneBlueprint `.sbdef` |
|---|---|---|
| 用途 | 游戏状态 Component 定义 | Action 端口 / Marker 类型定义 |
| 生成物 | struct + 序列化 + 访问器 | 字符串常量 + Marker 骨架 |
| 复杂度 | 高（F# 实现，支持泛型、继承）| 低（纯 C#，仅需常量生成）|
| 业务逻辑 | System 手写 | System 手写 |
| 触发机制 | `ScriptedImporter` + 内嵌 `AssetPostprocessor` | 同左（参考 `FSDSLAssetImporter.cs`）|
